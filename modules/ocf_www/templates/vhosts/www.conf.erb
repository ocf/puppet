<VirtualHost *:443>
    ServerName www.ocf.berkeley.edu
    ServerAlias secure.ocf.berkeley.edu ocf.berkeley.edu dev-www.ocf.berkeley.edu dev-ocf.berkeley.edu
    ServerAdmin help@ocf.berkeley.edu

    # canonical hostname is www.ocf.berkeley.edu
    RewriteEngine on
    RewriteCond %{HTTP_HOST} !^(dev-)?www\.ocf\.berkeley\.edu$ [NC]
    RewriteRule ^/(.*)$ https://www.ocf.berkeley.edu/$1 [R=301]

    DocumentRoot /srv/sites/ocf/www
    <Directory /srv/sites/ocf/www/>
        DirectoryIndex index.shtml index.html
        Options IncludesNoExec Indexes FollowSymlinks

        # Allow caching of shtml pages
        SSILastModified on

        # Add missing tilde for user dirs
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^([a-z]{3,8}(/.*)?)$ /~$1 [R=301]

        # Disable .htaccess files
        AllowOverride None
    </Directory>

    ScriptAlias /cgi-bin/ /srv/sites/ocf/cgi-bin/
    Alias /staff_hours /srv/sites/ocf/cgi-bin/staff_hours.cgi
    <Directory /srv/sites/ocf/cgi-bin>
        Options Includes ExecCGI FollowSymlinks

        # Disable .htaccess files for performance
        AllowOverride None
    </Directory>

    LogLevel warn
    ErrorLog ${APACHE_LOG_DIR}/error.log

    CustomLog ${APACHE_LOG_DIR}/ssl_access.log combined

    SSLEngine on
	SSLCertificateFile /etc/ssl/private/<%= @fqdn %>.crt
	SSLCertificateKeyFile /etc/ssl/private/<%= @fqdn %>.key
	SSLCertificateChainFile /etc/ssl/certs/incommon-intermediate.crt
	Include ssl-common.conf

    <FilesMatch "\.(cgi|shtml|phtml|php)$">
        SSLOptions +StdEnvVars
    </FilesMatch>
    <Directory /srv/sites/ocf/cgi-bin>
        SSLOptions +StdEnvVars
    </Directory>

    Header set Strict-Transport-Security "max-age=31536000"

    Alias /control /srv/sites/control
    <Location /control>
        Options ExecCGI
        AddHandler cgi-script .cgi
    </Location>
</VirtualHost>

# redirect http to https
<VirtualHost *:80>
    ServerName www.ocf.berkeley.edu
    ServerAlias www ocf.berkeley.edu dev-www.ocf.berkeley.edu dev-ocf.berkeley.edu secure.ocf.berkeley.edu
    ServerAdmin help@ocf.berkeley.edu
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    Redirect 301 / https://www.ocf.berkeley.edu/
</VirtualHost>
