// ACLs
acl "ocf" {
  169.229.226.0/24;
  2607:f140:8801::/48;
};

acl "ucb" {
  {
    128.32/16;
    136.152/16;
    169.229/16;
    208.1.64/19;
    192.31.161/24;
    192.58.221/24;
    2607:f140::/32;
  };
};

// Options
options {
  directory "/var/cache/bind";

  // Forward requests to campus nameservers
  forwarders {
    128.32.206.9;
    128.32.136.9;
    128.32.206.12;
    128.32.136.12;
    169.229.2.171;
    169.229.203.4;
  };

  dnssec-enable yes;
  dnssec-lookaside auto;
  key-directory "/etc/bind/keys";

  // Don't validate DNSSEC yet, since mesos-dns doesn't support it
  // dnssec-must-be-secure doesn't work either unfortunately :(
  // Neither does using disable-algorithms on only the mesos zone
  dnssec-validation no;

  // Allow queries from anywhere and zone transfers from OCF/UCB
  allow-query { any; };
  allow-transfer { "ocf"; "ucb"; "localhost"; };

  // Only allow recursive queries from OCF
  recursion yes;
  allow-recursion { "ocf"; "localhost"; };
};

// Query URIBL directly because campus nameservers are often blocked
zone "multi.uribl.com" {
  type forward;
  forwarders {};
};

key "letsencrypt.ocf.io" {
  // Unfortunately bind9 does not appear to support algorithms stronger than
  // hmac-md5 for user keys (used for dynamic DNS), but we can make the key
  // size fairly large at least. HMAC with md5 does not suffer from the
  // collision problems that md5 has, but ideally this would still be changed
  // to something stronger in the future.
  algorithm HMAC-MD5;
  secret "<%= @letsencrypt_ddns_key -%>";
};
