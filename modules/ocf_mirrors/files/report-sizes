#!/bin/bash
# Generate a "sizes" file in /opt/mirrors/ftp for convenience of us and any
# curious internet people.
set -euo pipefail

{
    find /opt/mirrors/ftp -mindepth 1 -maxdepth 1 -type d |
        sort |
        cut -d/ -f2 |
        grep -vE '^\.' |
        (xargs nice ionice du -hs || true) \
        2> >(grep -v '^du: cannot access' >&2)

    echo -n 'Last updated: '
    date
} | sponge /opt/mirrors/ftp/sizes
