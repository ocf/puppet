#!/bin/bash -eu

# The official "tier 0" syncing endpoint
# fallingrocks' IP is whitelisted, so if it ever changes, we need to email them to
# get access again.

# Adapted from https://git.server-speed.net/users/flo/bin/tree/syncrepo.sh

target="/opt/mirrors/ftp/archlinux"

source_url='rsync://rsync.archlinux.org/ftp_tier1'

lastupdate_url='http://rsync.archlinux.org/lastupdate'

#### END CONFIG

[ ! -d "${target}" ] && mkdir -p "${target}"

rsync_cmd() {
    local -a cmd=(/usr/local/bin/rsync-no-vanished -rtlH --safe-links --delete-after "--timeout=600" "--contimeout=60" -p \
        --delay-updates --no-motd)

    if stty &>/dev/null; then
        cmd+=(-h -v --progress)
    else
        cmd+=(--quiet)
    fi

    "${cmd[@]}" "$@"
}

# if we are called without a tty (cronjob) only run when there are changes
if ! tty -s && [[ -f "$target/lastupdate" ]] && diff -b <(curl -Ls "$lastupdate_url") "$target/lastupdate" >/dev/null; then
    # keep lastsync file in sync for statistics generated by the Arch Linux website
    rsync_cmd "$source_url/lastsync" "$target/lastsync"
    exit 0
fi

rsync_cmd \
    --exclude='*.links.tar.gz*' \
    "${source_url}" \
    "${target}"
