#!/usr/bin/env python3
import functools
import os
from configparser import ConfigParser

import redis


BROKER_AUTH = '/opt/share/broker/broker.conf'

redis_connection = functools.partial(
    redis.StrictRedis,
    host='broker',
    port=6378,
    ssl=True,
    db=0,
    password=None
)


def subscribe(host, password, *channels):
    rc = redis_connection(host=host, password=password)
    sub = rc.pubsub(ignore_subscribe_messages=True)
    sub.subscribe(channel for channel in channels)
    return sub


def read_config():
    config = ConfigParser()
    config.read(BROKER_AUTH)
    host = config.get('broker', 'host')
    password = config.get('broker', 'password')
    return host, password


def main():
    username = os.environ.get('SUDO_USER')

    if not username:
        raise RuntimeError('Unable to read SUDO_USER.')

    # read config file
    host, password = read_config()

    s = subscribe(host, password, username)
    for message in s.listen():
        _, status_message = (message['data'].decode(encoding='UTF-8')).split('\n')
        print(status_message, flush=True)


if __name__ == '__main__':
    main()
