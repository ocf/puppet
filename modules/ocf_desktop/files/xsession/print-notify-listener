#!/bin/bash -eu
function clean_up {
    jobs -pr | xargs pgrep -P | xargs sudo -u ocfbroker kill
    exit 0
}

trap clean_up INT TERM EXIT

pipe=$HOME/tmp/print-notify
icon=/opt/share/xsession/images/ocf-color-256.png

if [[ ! -p $pipe ]]; then
    mkfifo $pipe
fi

sudo -u ocfbroker /opt/share/puppet/print-notify-handler > $pipe &

# listener
while true
do
    if [[ ! -p $pipe ]]; then
        break
    fi
    if read msg < $pipe; then
	    notify-send -i $icon "Print Job Status" "$msg"
    fi
done
