#!/bin/sh

apt_cleanup(){
    # update cache then remove downloaded package archives, unused packages, and old config files
    /usr/bin/aptitude update --quiet > /dev/null
    /usr/bin/aptitude clean --quiet > /dev/null
    /usr/bin/aptitude purge --assume-yes --quiet '?garbage' > /dev/null
    /usr/bin/aptitude purge --assume-yes --quiet '?config-files' > /dev/null
}

if [ ! -f /var/lock/aptitude ]; then
  apt_cleanup
elif fuser -s /var/lock/aptitude; then
  true
else
  apt_cleanup
fi

<% if desktop -%>
# update-flashplugin-nonfree updates Adobe Flash Player
[ -x /usr/sbin/update-flashplugin-nonfree ] && /usr/sbin/update-flashplugin-nonfree --install --quiet || exit 0
<% end -%>

# debsecan reports packages missing security updates
debsecan_file='/etc/motd'
debsecan_sum='/tmp/debsecan.md5sum'
mailto='security'

# report format lists "Fixed vulnerabilities"
#debsecan="`/usr/bin/debsecan --suite <%= lsbdistcodename %> --format report --only-fixed`" > /dev/null
debsecan="`/usr/bin/debsecan --suite <%= lsbdistcodename %> --format report --only-fixed | grep -B1000 -Fx '*** Fixed vulnerabilities' | grep -vFx '*** Fixed vulnerabilities'`" > /dev/null
send_mail(){ echo "$debsecan" | mail -s "Security update: `hostname`" $mailto; }
make_sum(){ md5sum "$debsecan_file" > "$debsecan_sum"; }

# report format is not silent when there are no updates (Debian bug #588065)
#if [ -n "$debsecan" ]; then
if echo "$debsecan" | grep -Fq 'CVE-'; then
  echo "$debsecan" > "$debsecan_file"
<% if ! desktop -%>
  if [ -f "$debsecan_sum" ]; then
    md5sum --check --status "$debsecan_sum" || send_mail
  else
    send_mail
  fi
  make_sum
<% end -%>
else
  rm -f "$debsecan_file"
  rm -f "$debsecan_sum"
fi
